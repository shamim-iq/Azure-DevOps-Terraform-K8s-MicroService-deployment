trigger:
  branches:
    include:
      - main

variables:
  acrName: eydevopsacr
  acrLoginServer: eydevopsacr.azurecr.io
  aksClusterName: ey-devops-aks
  aksResourceGroup: ey-devops-rg
  imageTag: $(Build.BuildId)

stages:
# =========================
# BUILD & PUSH STAGE
# =========================
- stage: Build
  displayName: Build and Push Images
  jobs:
  - job: BuildImages
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: Login to ACR
      inputs:
        azureSubscription: Azure-Service-Connection
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az acr login --name $(acrName)

    - script: |
        docker build -t $(acrLoginServer)/backend:$(imageTag) app/backend
        docker build -t $(acrLoginServer)/frontend:$(imageTag) app/frontend
      displayName: Build Docker Images

    - script: |
        docker push $(acrLoginServer)/backend:$(imageTag)
        docker push $(acrLoginServer)/frontend:$(imageTag)
      displayName: Push Images to ACR

# =========================
# SECURITY SCAN STAGE
# =========================
- stage: Security
  displayName: Container Security Scan
  dependsOn: Build
  jobs:
  - job: TrivyScan
    pool:
      vmImage: ubuntu-latest
    steps:
    - script: |
        sudo apt-get install wget -y
        wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.0_Linux-64bit.tar.gz
        tar zxvf trivy_0.50.0_Linux-64bit.tar.gz
        ./trivy image $(acrLoginServer)/backend:$(imageTag)
      displayName: Trivy Image Scan

# =========================
# DEPLOY TO AKS
# =========================
- stage: Deploy
  displayName: Deploy to AKS
  dependsOn: Security
  jobs:
  - job: DeployAKS
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: AzureCLI@2
      displayName: Configure kubectl
      inputs:
        azureSubscription: Azure-Service-Connection
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az aks get-credentials \
            --resource-group $(aksResourceGroup) \
            --name $(aksClusterName) \
            --overwrite-existing

    - script: |
        sed -i 's|:latest|:$(imageTag)|g' k8s/backend-deployment.yaml
        sed -i 's|:latest|:$(imageTag)|g' k8s/frontend-deployment.yaml
      displayName: Update Image Tags

    - script: |
        kubectl apply -f k8s/
      displayName: Deploy to AKS

# =========================
# ROLLBACK (MANUAL)
# =========================
- stage: Rollback
  displayName: Manual Rollback
  dependsOn: Deploy
  condition: failed()
  jobs:
  - job: RollbackJob
    pool:
      vmImage: ubuntu-latest
    steps:
    - script: |
        kubectl rollout undo deployment/backend
        kubectl rollout undo deployment/frontend
      displayName: Rollback Deployments
